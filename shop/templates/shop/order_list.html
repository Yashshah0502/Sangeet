{% extends 'shop/base.html' %}
{% block title %}Orders - Sangeet by Gitika{% endblock %}
{% block content %}

<style>
  th, td { vertical-align: middle !important; }
  .table {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  }
  .order-summary {
    background: #f8f9fa;
    border-top: 2px solid #dee2e6;
  }
  .table img {
    object-fit: cover;
    border-radius: 8px;
  }
  .badge { font-size: 0.85rem; }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold"><i class="bi bi-box-seam me-2"></i>Order Management</h2>
  </div>

  {% if messages %}
    {% for message in messages %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  {% endif %}

  <div class="table-responsive">
    <table class="table table-hover align-middle text-center mb-0">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Product</th>
          <th>Photo</th>
          <th>Price</th>
          <th>Qty</th>
          <th>Breakdown</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>
            {% if order.order_id %}
              <span class="badge bg-secondary">{{ order.order_id }}</span>
            {% else %}
              <span class="badge bg-warning text-dark">Pending</span>
            {% endif %}
          </td>
          <td>
            <strong>{{ order.customer_name }}</strong><br />
            <small class="text-muted">{{ order.customer_email }}</small>
          </td>
          <td>{{ order.product.name }}</td>
          <td>
            {% if order.product.image %}
              <img src="{{ order.product.image.url }}" alt="{{ order.product.name }}" width="60" height="60">
            {% else %}
              <img src="https://via.placeholder.com/60x60?text=No+Image" width="60" height="60">
            {% endif %}
          </td>
          <td>₹{{ order.product.price|floatformat:2 }}</td>
          <td>{{ order.quantity }}</td>
          <td class="text-start">
            {% comment %} Compute subtotal, tax, total same as view {% endcomment %}
            {% with subtotal=order.product.price|floatformat:2|floatformat:2 %}
              <div><strong>Subtotal:</strong> ₹{{ order.subtotal|floatformat:2 }}</div>
              <div><small>Tax (18%): ₹{{ order.tax|floatformat:2 }}</small></div>
              <div class="fw-bold text-success">Total: ₹{{ order.total|floatformat:2 }}</div>
            {% endwith %}
          </td>
          <td>{{ order.created_at|date:"M d, Y H:i" }}</td>
          <td>
            <!-- Delete button -->
            <button
              type="button"
              class="btn btn-danger btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#deleteModal{{ order.id }}"
            >
              <i class="bi bi-trash"></i>
            </button>

            <!-- Delete modal -->
            <div class="modal fade" id="deleteModal{{ order.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    Are you sure you want to delete Order <strong>#{{ order.order_id }}</strong>?
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="{% url 'delete_order' order.id %}" class="btn btn-danger">Yes, Delete</a>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-muted py-4">No orders placed yet.</td>
        </tr>
        {% endfor %}
      </tbody>

      {% if orders %}
      <tfoot class="order-summary">
        <tr>
          <td colspan="7" class="text-end fw-bold">Total Tax:</td>
          <td colspan="2" class="fw-semibold text-success">
            ₹{{ total_tax|floatformat:2 }}
          </td>
        </tr>
        <tr>
          <td colspan="7" class="text-end fw-bold">Total Revenue (incl. Tax):</td>
          <td colspan="2" class="fw-bold text-primary">
            ₹{{ total_revenue|floatformat:2 }}
          </td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
</div>

{% endblock %}
